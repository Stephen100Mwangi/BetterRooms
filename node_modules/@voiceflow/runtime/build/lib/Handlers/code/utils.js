"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.vmExecute = void 0;
const lodash_1 = __importDefault(require("lodash"));
const sync_1 = __importDefault(require("require-from-url/sync"));
const vm2_1 = require("vm2");
// eslint-disable-next-line import/prefer-default-export
exports.vmExecute = (data, safe = true /* set to false when running in testing env */, callbacks) => {
    const vm = new vm2_1.VM({
        timeout: 1000,
        sandbox: Object.assign(Object.assign(Object.assign({ Promise: null }, lodash_1.default.cloneDeep(data.variables)), { requireFromUrl: sync_1.default }), callbacks),
    });
    const clearContext = `
          (function() {
            Function = undefined;
            const keys = Object.getOwnPropertyNames(this).concat(['constructor']);
            keys.forEach((key) => {
              const item = this[key];
              if (!item || typeof item.constructor !== 'function') return;
              this[key].constructor = undefined;
            });
          })();`;
    vm.run(`${safe ? clearContext : ''} ${data.code}`);
    return Object.keys(data.variables).reduce((acc, key) => {
        acc[key] = lodash_1.default.get(vm, '_context')[key];
        return acc;
    }, {});
};
//# sourceMappingURL=utils.js.map